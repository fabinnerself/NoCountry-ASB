# Fase/Iteraci√≥n 0: Desarrollo de Funci√≥n Story Generator

## üéØ Objetivo General - Iteraci√≥n 0
Desarrollar y validar la funci√≥n base de generaci√≥n de historias que ser√° llamada desde el endpoint `/api/generate-story`, utilizando TDD y preparando la infraestructura para fases posteriores con PostgreSQL .

## Objetivo Final (Full Project)
Desarrollar AutoStory Builder completo seg√∫n la definici√≥n en `desc_gral_proy_auto_store-builder.txt`: sistema de IA para generar historias visuales y textuales a partir de inputs multimedia, con panel de edici√≥n, exportaci√≥n y RAG.

---

## üìã Alcance de Fase 0

### Endpoint Principal: POST /api/generate-story

**Input JSON:**
```json
{
  "tone": "INSPIRACIONAL" | "EDUCATIVO" | "T√âCNICO",
  "format": "HISTORIA" | "POST" | "REDES_SOCIALES" | "OTRO",
  "text": "string (min 20, max 1000 chars)"
}
```

**Ejemplo de Input:**
```json
{
  "tone": "INSPIRACIONAL",
  "format": "REDES_SOCIALES",
  "text": "Joven de comunidad rural accedi√≥ a programa de becas tecnol√≥gicas. Super√≥ barreras de conectividad y hoy trabaja como desarrollador remoto, ayudando a su familia."
}
```

**Output JSON:**
```json
{
  "success": "ok",
  "generatedStory": "string (historia generada)",
  "validation": {
    "tone": "ok" | "error",
    "format": "ok" | "error",
    "text": "ok" | "error"    
  },
  "metadata": {
    "wordCount": 95,
    "tone": "INSPIRACIONAL",
    "format": "REDES_SOCIALES",
    "generatedAt": "2025-12-09T02:13:27.227Z",
    "model": "command-r-plus"
  }
}
```

**Ejemplo de Output:**
```json
{
  "success": "ok",
  "generatedStory": "üåü De las monta√±as al c√≥digo: la historia de superaci√≥n de Juan\n\nSin internet estable, con solo su determinaci√≥n y un celular prestado, Juan aprendi√≥ a programar. Hoy, desde su pueblo, trabaja para empresas internacionales y est√° cambiando el futuro de su familia.\n\n¬øCu√°l es tu historia de superaci√≥n? üí™\n\n#Inspiraci√≥n #Tecnolog√≠a #Superaci√≥n",
  "validation": {
    "tone": "ok",
    "format": "ok",
    "wordCount": "ok"
  },
  "metadata": {
    "wordCount": 95,
    "tone": "INSPIRACIONAL",
    "format": "REDES_SOCIALES",
    "generatedAt": "2025-12-09T02:13:27.227Z",
    "model": "command-r-plus"
  }
}
```

### Entrada (3 variables iniciales)
- `tone`: String - Tono de la narrativa
  - Valores v√°lidos: "INSPIRACIONAL", "EDUCATIVO", "T√âCNICO"
- `format`: String - Formato de salida
  - Valores v√°lidos: "HISTORIA", "POST", "REDES_SOCIALES", "OTRO"
- `text`: String - Contexto/informaci√≥n base para la historia
  - Longitud: 20-1000 caracteres

**Nota:** La imagen con captions se integrar√° en fases posteriores (Fase 1 o siguiente).

---

## üèóÔ∏è Arquitectura T√©cnica

### Stack Tecnol√≥gico

**Backend:**
- Node.js/Express (c√≥digo base existente)
- PostgreSQL + pgvector extension
- Prisma ORM
- Jest/Mocha (TDD)
- Deployment: Render

**Frontend:**
- Core: React (v18+), Vite
- Estilos: Tailwind CSS
- Componentes UI: Radix UI
- Iconos: Lucide React
- Formularios: React Hook Form
- Gr√°ficos: Recharts
- Notificaciones: Sonner
- Temas: Next Themes
- Deployment: Vercel

**IA:**
- Cohere API (https://dashboard.cohere.com/playground/chat)
- API Key configurada en .env ‚Üí COHERE_API_KEY

### Variables de Entorno (.env)

```env
# ============================================
# SERVER CONFIGURATION
# ============================================
PORT=8000

# ============================================
# DATABASE CONFIGURATION
# ============================================
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/autostory_db?schema=public"

# ============================================
# API KEYS
# ============================================
COHERE_API_KEY="***************************"

# ============================================
# CORS - FRONTEND URLS
# ============================================
FRONTEND_URL_LOCAL="http://localhost:5173"
FRONTEND_URL="https://tu-frontend.vercel.app"

# ============================================
# ENVIRONMENT
# ============================================
NODE_ENV="development"

# ============================================
# PUERTOS - GU√çA R√ÅPIDA
# ============================================
# Backend API:     http://localhost:8000
# PostgreSQL:      localhost:5432
# Frontend (Vite): http://localhost:5173
# ============================================
```

### Validaciones y Reglas

**Campos requeridos:** `tone`, `format`, `text`

**Dominios v√°lidos:**
- `tone`: "INSPIRACIONAL", "EDUCATIVO", "T√âCNICO"
- `format`: "HISTORIA", "POST", "REDES_SOCIALES", "OTRO"
- `text`: 20-1000 caracteres

**Mensajes de error:**
- Tono inv√°lido: `"Valor de tone no v√°lido: [valor recibido]. Valores permitidos: INSPIRACIONAL, EDUCATIVO, T√âCNICO"`
- Formato inv√°lido: `"Valor de format no v√°lido: [valor recibido]. Valores permitidos: HISTORIA, POST, REDES_SOCIALES, OTRO"`
- Texto inv√°lido: `"El texto debe tener entre 20 y 1000 caracteres. Recibido: [longitud]"`

**Validaci√≥n de output:**
- Longitud: 80-120 palabras
- Estructura: Gancho ‚Üí Desarrollo ‚Üí Cierre inspirador
- Incluir llamado a la acci√≥n (para formatos de redes sociales)

---

## üîß Implementaci√≥n Paso a Paso

### 1. Preparaci√≥n del Entorno
- [ ] Configurar API Key de Cohere en `.env`
- [ ] Instalar dependencias: `cohere-ai`, `dotenv`
- [ ] Revisar c√≥digo base funcional de etapa 0

### 2. Desarrollo del Prompt Template

```javascript
const STORY_PROMPT_TEMPLATE = `
Eres un experto en storytelling que crea narrativas impactantes para organizaciones sociales.

TONO SOLICITADO: {tone}
{toneGuidelines}

FORMATO SOLICITADO: {format}
{formatGuidelines}

CONTEXTO/INFORMACI√ìN BASE:
{text}

REGLAS GENERALES:
- Extensi√≥n: 80-120 palabras
- Estructura: Gancho ‚Üí Desarrollo breve ‚Üí Cierre inspirador
- Lenguaje conversacional y cercano
- Incluir llamado a la acci√≥n cuando sea apropiado

Genera una historia siguiendo todas las especificaciones anteriores.
`;

const TONE_GUIDELINES = {
  INSPIRACIONAL: `
    - Usar lenguaje emotivo que conecte con sentimientos de esperanza y superaci√≥n
    - Palabras clave: superaci√≥n, esperanza, cambio, impacto, comunidad
    - Estructura narrativa: Situaci√≥n desafiante ‚Üí Esfuerzo y cambio ‚Üí Transformaci√≥n ‚Üí Mensaje esperanzador
  `,
  EDUCATIVO: `
    - Usar lenguaje claro y did√°ctico
    - Incluir datos, hechos o aprendizajes concretos
    - Estructura: Problema/pregunta ‚Üí Explicaci√≥n ‚Üí Conclusi√≥n/aplicaci√≥n
  `,
  T√âCNICO: `
    - Usar terminolog√≠a precisa y profesional
    - Enfocarse en procesos, metodolog√≠as o soluciones
    - Estructura: Contexto t√©cnico ‚Üí Implementaci√≥n ‚Üí Resultados/m√©tricas
  `
};

const FORMAT_GUIDELINES = {
  HISTORIA: `
    - Narrativa completa con inicio, desarrollo y cierre
    - Enfoque en personajes y su transformaci√≥n
    - Estilo literario y descriptivo
  `,
  POST: `
    - Formato de blog post o art√≠culo breve
    - P√°rrafos cortos y escaneables
    - Incluir t√≠tulo impl√≠cito en el contenido
  `,
  REDES_SOCIALES: `
    - Formato optimizado para redes sociales
    - Usar emojis estrat√©gicamente
    - Incluir hashtags relevantes al final
    - Llamado a la acci√≥n claro
  `,
  OTRO: `
    - Formato flexible adaptado al contexto
    - Mantener claridad y concisi√≥n
  `
};
```

### 3. Desarrollo de la Funci√≥n Principal (TDD)

#### Tests a Implementar

```javascript
// tests/storyGenerator.test.js
describe('Story Generator', () => {
  test('debe generar historia con 3 variables v√°lidas', async () => {
    const input = {
      tone: 'INSPIRACIONAL',
      format: 'REDES_SOCIALES',
      text: 'Joven de comunidad rural accedi√≥ a programa de becas tecnol√≥gicas.'
    };
    const result = await generateStory(input);
    expect(result.success).toBe(true);
    expect(result.generatedStory).toBeDefined();
  });

  test('debe validar longitud entre 80-120 palabras', async () => {
    const result = await generateStory(validInput);
    const wordCount = result.generatedStory.split(/\s+/).length;
    expect(wordCount).toBeGreaterThanOrEqual(80);
    expect(wordCount).toBeLessThanOrEqual(120);
  });

  test('debe rechazar tone inv√°lido', async () => {
    const input = { tone: 'INVALIDO', format: 'POST', text: 'Texto v√°lido de prueba' };
    await expect(generateStory(input)).rejects.toThrow('Valor de tone no v√°lido');
  });

  test('debe rechazar format inv√°lido', async () => {
    const input = { tone: 'EDUCATIVO', format: 'INVALIDO', text: 'Texto v√°lido de prueba' };
    await expect(generateStory(input)).rejects.toThrow('Valor de format no v√°lido');
  });

  test('debe rechazar texto muy corto', async () => {
    const input = { tone: 'T√âCNICO', format: 'HISTORIA', text: 'Corto' };
    await expect(generateStory(input)).rejects.toThrow('debe tener entre 20 y 1000 caracteres');
  });

  test('debe manejar errores de API Cohere', async () => {
    // Mock API error
    jest.spyOn(cohere, 'chat').mockRejectedValue(new Error('API Error'));
    await expect(generateStory(validInput)).rejects.toThrow();
  });

  test('debe aplicar correctamente el tono solicitado', async () => {
    const result = await generateStory({ tone: 'INSPIRACIONAL', format: 'POST', text: validText });
    expect(result.metadata.tone).toBe('INSPIRACIONAL');
  });
});
```

#### Estructura de la Funci√≥n

```javascript
// services/storyGenerator.js
const { CohereClient } = require('cohere-ai');

const VALID_TONES = ['INSPIRACIONAL', 'EDUCATIVO', 'T√âCNICO'];
const VALID_FORMATS = ['HISTORIA', 'POST', 'REDES_SOCIALES', 'OTRO'];

async function generateStory({ tone, format, text }) {
  // 1. Validaci√≥n de inputs
  validateInputs({ tone, format, text });

  // 2. Construcci√≥n del prompt parametrizado
  const prompt = buildPrompt({ tone, format, text });

  // 3. Llamada a Cohere API
  const cohere = new CohereClient({
    token: process.env.COHERE_API_KEY,
  });

  const response = await cohere.chat({
    message: prompt,
    model: "command-r-plus",
    temperature: 0.7
  });

  const generatedStory = response.text;

  // 4. Validaci√≥n de output
  const validation = validateOutput(generatedStory);

  // 5. Retorno de resultado estructurado
  return {
    success: true,
    generatedStory,
    validation,
    metadata: {
      wordCount: generatedStory.split(/\s+/).length,
      tone,
      format,
      generatedAt: new Date().toISOString(),
      model: "command-r-plus"
    }
  };
}

function validateInputs({ tone, format, text }) {
  if (!VALID_TONES.includes(tone)) {
    throw new Error(`Valor de tone no v√°lido: ${tone}. Valores permitidos: ${VALID_TONES.join(', ')}`);
  }
  if (!VALID_FORMATS.includes(format)) {
    throw new Error(`Valor de format no v√°lido: ${format}. Valores permitidos: ${VALID_FORMATS.join(', ')}`);
  }
  if (!text || text.length < 20 || text.length > 1000) {
    throw new Error(`El texto debe tener entre 20 y 1000 caracteres. Recibido: ${text?.length || 0}`);
  }
}

function buildPrompt({ tone, format, text }) {
  return STORY_PROMPT_TEMPLATE
    .replace('{tone}', tone)
    .replace('{toneGuidelines}', TONE_GUIDELINES[tone])
    .replace('{format}', format)
    .replace('{formatGuidelines}', FORMAT_GUIDELINES[format])
    .replace('{text}', text);
}

function validateOutput(story) {
  const wordCount = story.split(/\s+/).length;
  return {
    tone: 'ok',
    format: 'ok',
    wordCount: (wordCount >= 80 && wordCount <= 120) ? 'ok' : 'error'
  };
}

module.exports = { generateStory };
```

### 4. Endpoint REST API

```javascript
// routes/story.routes.js
const express = require('express');
const { generateStory } = require('../services/storyGenerator');
const router = express.Router();

router.post('/generate-story', async (req, res) => {
  try {
    const { tone, format, text } = req.body;
    const result = await generateStory({ tone, format, text });
    res.json(result);
  } catch (error) {
    res.status(400).json({
      success: false,
      error: error.message
    });
  }
});

module.exports = router;
```

---

## ‚úÖ Criterios de Validaci√≥n (DoD)

- [ ] Tests unitarios pasan al 100%
- [ ] Endpoint responde correctamente con 3 variables
- [ ] Historias generadas cumplen 80-120 palabras
- [ ] Manejo de errores implementado con mensajes claros
- [ ] Documentaci√≥n API actualizada
- [ ] C√≥digo conectado al backend/frontend existente
- [ ] Variables de entorno configuradas
- [ ] Schema Prisma definido para futura persistencia
- [ ] Validaciones de input funcionando correctamente
- [ ] Validaciones de output implementadas

---

## üöÄ Siguiente Fase (Preparaci√≥n)

Una vez validada Fase 0, preparar para:
- Integraci√≥n de imagen + captions (4ta variable)
- An√°lisis de imagen con IA
- Extracci√≥n de embeddings con pgvector
- Sistema de b√∫squeda sem√°ntica (RAG)
- Persistencia de historias en PostgreSQL
- Sistema de usuarios y autenticaci√≥n

---

## üìö Recursos y Referencias

- [Cohere API Docs](https://docs.cohere.com/)
- [Prisma + PostgreSQL](https://www.prisma.io/docs/concepts/components/prisma-client/databases/postgresql)
- [pgvector Extension](https://github.com/pgvector/pgvector)
- C√≥digo base etapa 0: `proy1/`
- Estructura de BD propuesta: `db_struct.sql`
- Descripci√≥n general del proyecto: `desc_gral_proy_auto_store-builder.txt`

---

## üêõ Debugging & Testing

### Testing Local

```bash
# 1. Instalar dependencias
npm install

# 2. Configurar variables de entorno
cp .env.example .env
# Editar .env con tus credenciales

# 3. Ejecutar tests
npm test

# 4. Iniciar servidor de desarrollo
npm run dev

# 5. Probar endpoint
curl -X POST http://localhost:8000/api/generate-story \
  -H "Content-Type: application/json" \
  -d '{
    "tone": "INSPIRACIONAL",
    "format": "REDES_SOCIALES",
    "text": "Joven de comunidad rural accedi√≥ a programa de becas tecnol√≥gicas. Super√≥ barreras de conectividad y hoy trabaja como desarrollador remoto, ayudando a su familia."
  }'
```

### Validaci√≥n Manual

1. Verificar que el story cumple 80-120 palabras
2. Confirmar que refleja el tono solicitado
3. Validar estructura: gancho ‚Üí desarrollo ‚Üí cierre
4. Comprobar llamado a la acci√≥n presente (para REDES_SOCIALES)
5. Verificar que el formato es apropiado

---

## üìù Notas de Implementaci√≥n

- **TDD First:** Escribir tests antes del c√≥digo
- **C√≥digo Base:** Usar el c√≥digo funcional existente como base
- **Modularidad:** Mantener la funci√≥n modular para f√°cil integraci√≥n de imagen en fases posteriores
- **Documentaci√≥n:** Documentar decisiones t√©cnicas importantes
- **Commits:** Realizar commits at√≥micos por funcionalidad
- **Consistencia:** Usar nombres de variables en ingl√©s en el c√≥digo, espa√±ol en la documentaci√≥n

---

## üîÑ Evoluci√≥n del Contrato API

### Fase 0 (Actual)
- Input: `tone`, `format`, `text`
- Output: `success`, `generatedStory`, `validation`, `metadata`

### Fase 1 (Futura)
- Input adicional: `idUser`, `operacion` ("GENERAR" | "REGENERAR" | "EDITAR"), `image` (opcional)
- Output adicional: `id_story` (UUID), persistencia en BD

### Fase 2+ (Futura)
- RAG: B√∫squeda sem√°ntica de historias similares
- An√°lisis de imagen con IA
- Panel de edici√≥n interactivo
- Exportaci√≥n en m√∫ltiples formatos
